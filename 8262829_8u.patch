
# HG changeset patch
# User aivanov
# Date 1615289790 0
# Node ID e809ace546fd5c93563f78084f3fc18141f7cea1
# Parent  1c1c23728328c46ae5a8601420c04ebaf1d50992
8262829: Native crash in Win32PrintServiceLookup.getAllPrinterNames()
Reviewed-by: prr, psadhukhan, serb

diff -r 1c1c23728328 -r e809ace546fd src/windows/native/sun/windows/WPrinterJob.cpp
--- a/src/windows/native/sun/windows/WPrinterJob.cpp	Mon Mar 08 16:38:21 2021 +0000
+++ b/src/windows/native/sun/windows/WPrinterJob.cpp	Tue Mar 09 11:36:30 2021 +0000
@@ -1,5 +1,5 @@
 /*
- * Copyright (c) 2000, 2020, Oracle and/or its affiliates. All rights reserved.
+ * Copyright (c) 2000, 2021, Oracle and/or its affiliates. All rights reserved.
  * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
  *
  * This code is free software; you can redistribute it and/or modify it
@@ -133,12 +133,25 @@
     jobjectArray nameArray;
 
     try {
-        ::EnumPrinters(flags,
-                       NULL, 4, NULL, 0, &cbNeeded, &cReturned);
-        pPrinterEnum = new BYTE[cbNeeded];
-        ::EnumPrinters(flags,
-                       NULL, 4, pPrinterEnum, cbNeeded, &cbNeeded,
-                       &cReturned);
+        ::EnumPrinters(flags, NULL, 4, NULL,
+                       0, &cbNeeded, &cReturned);
+
+        BOOL bResult;
+        int nCount = 0;
+        do {
+            if (pPrinterEnum != NULL) {
+                delete [] pPrinterEnum;
+            }
+            pPrinterEnum = new BYTE[cbNeeded];
+
+            bResult = ::EnumPrinters(flags, NULL, 4, pPrinterEnum,
+                                     cbNeeded, &cbNeeded, &cReturned);
+        } while (!bResult && ++nCount < 5);
+
+        if (!bResult) {
+            // No printers in case of error
+            cReturned = 0;
+        }
 
         if (cReturned > 0) {
             nameArray = env->NewObjectArray(cReturned, clazz, NULL);

